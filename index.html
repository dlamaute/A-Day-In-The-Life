<!DOCTYPE html>
<html>
  <head>
    <title>Filter</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  	<script type="text/javascript" src="http://d3js.org/d3.v5.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  	<style>

      #main-wrapper {
        width: 1500px;
        height: 1000px;
      }

      #top {
        height: 300px;
      }

      #topLeft {
        display: inline-block;
        width: 55%;
        height: inherit;
      }

      #topRight {
        position: relative;
        float: right;
        display: inline-block;
        width: 45%;
        height: inherit;
      }

      h1 {
          color: gray;
          font-family: 'Montserrat', sans-serif; 
          margin: 8px;
          margin-top: 16px;
      }

      h2 {
        color: gray;
        font-family: 'Montserrat', sans-serif; 
        margin: 24px; 
      }
      
      h3 {
        color: gray;
        font-family: 'Montserrat', sans-serif;
        margin: 24px; 
      }
      
      p {
        color: gray;
        font-family: 'Montserrat', sans-serif;
        font-size: 14px;
        margin: 8px;
        margin-left: 24px;
      }
      
      span {
        color: gray;
        font-family: 'Montserrat', sans-serif;
        margin: 14px; 
      }

      #filters{
        font-family: 'Montserrat';
        color: white;
        border: none;
        margin-left: 24px;
        margin-right: 24px;
        width: 80%; /*60vw;*/
      }
      
      .filterOption{
        border-width: 1px;
        margin-right: 8px;
        margin-bottom: 8px;
        margin-top: 8px;
        height: 32px;
        background-color: #aeaeae;
        color: white;
        font-size: 14px;
        font-family: 'Montserrat'
      }

      .graph {
        border-radius: 3px;
        padding: 4px;
        margin: 8;
        background-color: #ffffff;
        width: 20vw;
        height: 20vh;
      }

      #legend {
        height: inherit; 
      }

    </style>
  </head>

  <body>
    <div id="main-wrapper">
      <div id="top">
        <div id="topLeft">
          <h2>Different days in the life</h1> 
          <h3>What is it like to struggle with depression?</h2>
          <p> Find individual stories for... <p/>
          
          <div id="filters">
            <select id="Age" class="filterOption"></select>
            <span>year old</span>
            <select id="Gender" class="filterOption"></select>
            <span>people who identify as</span>
            <select id="Sexual_Identity" class="filterOption"></select>
            <span>with a total family income of</span>
            <select id="Total_Family_Income" class="filterOption"></select>
            </span>.</span>
          </div>
        </div>
        <div id="topRight">
          <img src="images/a3-legend-03.png" alt="legend" id="legend"> 
          <!-- style="position:relative;float:right;width:324px;"> -->
        </div>
      </div>

      <div id="graphsContainer">
        <table id="graphs">
          <tr> 
            <td id="graph1Container" class="graph"><div id="graph1"></div><div class="graphText">Placeholder Text</div></td>
            <td id="graph2Container" class="graph"><div id="graph2"></div><div class="graphText">Placeholder Text</div></td>
            <td id="graph3Container" class="graph"><div id="graph3"></div><div class="graphText">Placeholder Text</div></td>
            <td id="graph4Container" class="graph"><div id="graph4"></div><div class="graphText">Placeholder Text</div></td>
          </tr>
        </table>
      </div>
    </div>
  </body>

  <script type="text/javascript">

    var chartMargin = "8px";
    var chartHeight = "20vh";
    var chartWidth = "20vw";

    var graphHeight = "350px";
    var graphWidth = "350px";

    // data values for drop downs & blob coloring
    var key = {
      "Age": ["18", "19", "20", "21", "23-22", "24-25", "26-29", "30-34", "35-39", "40-44", "45-49", "50-64", "65+"],
      "Gender": ["Male", "Female"],
      "Sexual_Identity": ["Heterosexual", "Lesbian or Gay", "Bisexual"],
      "Total_Family_Income": ["Less than $10,000 (Including Loss)", "$10,000 - $19,999", "$20,000 - $29,999", "$30,000 - $39,999", "$40,000 - $49,999", "$50,000 - $74,999", "$75,000 or more"],
      "Days_Lost": ["0", "<10 days", "10-30 days", "31-90 days", "91-180 days", ">180 days"]
    };

    // for blob coloring
    var colorKey = {
      "0": {"fill": "rgba(0,255,230,0.5)", "line": "rgba(0,255,230,1)"}, 
      "<10 days": {"fill": "rgba(30,196,196,0.5)", "line": "rgba(30,196,196,1)"}, 
      "10-30 days": {"fill": "rgba(51,140,140,0.5)", "line": "rgba(51,140,140,1)"}, 
      "31-90 days": {"fill": "rgba(99,137,137,0.5)", "line": "rgba(99,137,137,1)"}, 
      "91-180 days": {"fill": "rgba(69,79,79,0.5)", "line": "rgba(69,79,79,1)"}, 
      ">180 days": {"fill": "rgba(17,17,17,0.5)", "line": "rgba(17,17,17,1)"}
    }

    var plotLayout = {
        polar: {
          radialaxis: {
            visible: true,
            range: [0, 5]
          }
        },
        xaxis: {
          fixedRange: true
        },
        yaxis: {
          fixedRange: true
        },
        width: parseInt(graphWidth),
        height: parseInt(graphHeight),
        showlegend: false,
        paper_bgcolor: "rgba(0, 0, 0, 0)"
      };

    var plotAddlParams = {
      showSendToCloud: false, 
      displayModeBar: false, 
      staticPlot: false,
    };

    // for using csv
    d3.csv('data/a3_df_inverted_ext.csv')
    .then(function(data) {
      var randomData = randomEntries(data);

      var selectRow = d3.select("#filters")
      // .attr("style", "display: inline-block;");
    
      var selectAge = selectRow.select("#Age")
        .on("change", update);
      var selectGender = selectRow.select("#Gender")
        .on("change", update);
      var selectOrientation = selectRow.select("#Sexual_Identity")
        .on("change", update);
      var selectIncome = selectRow.select("#Total_Family_Income")
        .on("change", update);

      var valuesAge = ["Any Age"].concat(key.Age);
      var valuesGender = ["Any Gender"].concat(key.Gender);
      var valuesOrientation = ["Any Sexual Identity"].concat(key.Sexual_Identity);
      var valuesIncome = ["Any Income"].concat(key.Total_Family_Income);

      var optionsAge = selectAge.selectAll(null)
        .data(valuesAge)
        .enter()
        .append("option")
        .text(function(d) {return d;});
      var optionsGender = selectGender.selectAll(null)
        .data(valuesGender)
        .enter()
        .append("option")
        .text(function(d) {return d;});
      var optionsOrientation = selectOrientation.selectAll(null)
        .data(valuesOrientation)
        .enter()
        .append("option")
        .text(function(d) {return d;});
      var optionsIncome = selectIncome.selectAll(null)
        .data(valuesIncome)
        .enter()
        .append("option")
        .text(function(d) {return d;});

      var graphsContainer = d3.select("#graphsContainer")
        .attr("width", chartWidth + chartMargin)
        .attr("height", chartHeight + chartMargin)
        .attr("style", "display: inline-block;"); //position: relative; top: -50px;");

      data1 = setupPlotData(randomData[0]);
      data2 = setupPlotData(randomData[1]);
      data3 = setupPlotData(randomData[2]);
      data4 = setupPlotData(randomData[3]);

      if (data1.length > 0) {
        Plotly.plot("graph1", data1, plotLayout, plotAddlParams);
      }
      if (data2.length > 0) {
        Plotly.plot("graph2", data2, plotLayout, plotAddlParams);
      }
      if (data3.length > 0) {
        Plotly.plot("graph3", data3, plotLayout, plotAddlParams);
      }
      if (data4.length > 0) {
        Plotly.plot("graph4", data4, plotLayout, plotAddlParams);
      }


      function update() {
        var choices = {};
        d3.selectAll(".filterOption")
          .each(function(d) {
            if (!this.value.startsWith("Any")) {
              choices[this.id] = this.value;
            }
          });

        var randomNewData;

        // filter dataset for entries that match the dropdown selections
        if (d3.keys(choices).length > 0) {
          var newData = data.filter(function(d,i) {
            var valid = true;
            for (var prop in choices) {
              if (d[prop] != choices[prop]) {
                valid = false;
                break;
              }
            }
            if (valid) {
              return d;
            }
          });
          randomNewData = randomEntries(newData);
          console.log(randomNewData, "subdata");
        } else {
          randomNewData = randomEntries(data);
          console.log(randomNewData, "general data");
        }

        var data1 = setupPlotData(randomNewData[0]);
        var data2 = setupPlotData(randomNewData[1]);
        var data3 = setupPlotData(randomNewData[2]);
        var data4 = setupPlotData(randomNewData[3]);

        var g1c = d3.select("#graph1Container");
        var g2c = d3.select("#graph2Container");
        var g3c = d3.select("#graph3Container");
        var g4c = d3.select("#graph4Container");

        if (data1.length > 0) {
          g2c.attr("style", "display: table-cell;")
            // .attr("width", graphWidth);
          Plotly.react("graph1", data1, plotLayout, plotAddlParams);
        } else {
          console.log("data1 missing"); // TODO: If this is the case, we should display a message
          g1c.attr("style", "display: none;");
        }
        if (data2.length > 0) {
          g2c.attr("style", "display: table-cell;")
            // .attr("width", graphWidth);
          Plotly.react("graph2", data2, plotLayout, plotAddlParams);
        } else {
          console.log("data2 missing");
          g2c.attr("style", "display: none;");
        }
        if (data3.length > 0) {
          g3c.attr("style", "display: table-cell;")
            // .attr("width", graphWidth);
          Plotly.react("graph3", data3, plotLayout, plotAddlParams);
        } else {
          console.log("data3 missing");
          g3c.attr("style", "display: none;");
        }
        if (data4.length > 0) {
          g4c.attr("style", "display: table-cell;")
            // .attr("width", graphWidth);
          Plotly.react("graph4", data4, plotLayout, plotAddlParams);
        } else {
          console.log(data4, "data4 missing");
          g4c.attr("style", "display: none;");
        }

      }

    })
    .catch(function(error) {
      console.log(error, ": could not load csv");
    });


    // Get 4 random entries from the provided data
    function randomEntries(d) {
      var n = d.length;
      var dCopy = Object.assign([], d);

      values = [];
      for (i = 0; i < 4; i++) {
        idx = d3.randomUniform(n)();
        newValues = dCopy.splice(idx, 1);
        validated = validatedValues(newValues);
        if (validated.length > 0) {
          values = values.concat(validated);
        } else {
          i -= 1;
        }

        n -= 1;
        
        if (n == 0) {
          break;
        }
      }

      return values;
    }

    // TODO: need rgb values
    function blobColor(d) {
      console.log(d.Days_Lost);
      console.log(colorKey[d.Days_Lost]);
      return colorKey[d.Days_Lost];
    }

    // Check if data passed in is valid to use
    function validatedValues(d) {
      var data = d[0];
      if (Object.keys(data).length > 0) {
        if (parseInt(data.ADPSWORK) > 10 || parseInt(data.ADPSWORK) < 0) {
          return [];
        } else if (parseInt(data.ADPSRELS) > 10 || parseInt(data.ADPSRELS) < 0) {
          return [];
        } else if (parseInt(data.ADPSSOC) > 10 || parseInt(data.ADPSSOC) < 0) {
          return [];
        } else if (parseInt(data.ADPSHMGT) > 10 || parseInt(data.ADPSHMGT) < 0) {
          return [];
        } else if (parseInt(data.ADPSWORK) > 10 || parseInt(data.ADPSWORK) < 0) {
          return [];
        } else if (!key.Days_Lost.includes(data.Days_Lost)) {
          return [];
        } else if (!key.Age.includes(data.Age)) {
          return [];
        } else if (!key.Gender.includes(data.Gender)) {
          return [];
        } else if (!key.Sexual_Identity.includes(data.Sexual_Identity)) {
          return [];
        } else if (!key.Total_Family_Income.includes(data.Total_Family_Income)) {
          return [];
        }
        return d;
      } else {
        return [];
      }  
    }

    function setupPlotData(d) {
      console.log(d, "-- dsetup");
      if (d != null && typeof d != "undefined" && Object.keys(d).length > 0) {
        work = d.ADPSWORK == 0 ? 1 : Math.ceil(parseInt(d.ADPSWORK)/2);
        rels = d.ADPSRELS == 0 ? 1 : Math.ceil(parseInt(d.ADPSRELS)/2);
        social = d.ADPSSOC == 0 ? 1 : Math.ceil(parseInt(d.ADPSSOC)/2);
        house = d.ADPSHMGT == 0 ? 1 : Math.ceil(parseInt(d.ADPSHMGT)/2);
        radii = [work, rels, social, house, work];
        console.log(radii, "-- rsetup");
        var colors = blobColor(d);
        var fillColor = colors.fill;
        var lineColor = colors.line;
        // fill color would be colors.fill and line would be colors.line
        return [{
        type: 'scatterpolar',
        r: radii,
        theta: ['Work', 'Relationships', 'Social Life', 'Home Management', 'Work'],
        fill: 'toself',
             fillcolor: fillColor,
             line: {lineColor, shape: "spline", smoothing: 1.3},
             marker: {color: 'rgba(177, 177, 180, 1)' }
        }]
      } else {
        return [];
      }
    }

  </script>
