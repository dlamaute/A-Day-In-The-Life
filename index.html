<!DOCTYPE html>
<html>
  <head>
    <title>Filter</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  	<script type="text/javascript" src="http://d3js.org/d3.v5.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
  	<style>
      h1 {
          color: gray;
          font-family: 'Montserrat', sans-serif; 
          margin: 8px;
          margin-top: 16px;
        }

      h2 {
        color: gray;
        font-family: 'Montserrat', sans-serif; 
        margin: 24px; 
      }
      
      h3 {
        color: gray;
        font-family: 'Montserrat', sans-serif;
        margin: 24px; 
      }
      
      p {
        color: gray;
        font-family: 'Montserrat', sans-serif;
        font-size: 14px;
        margin: 8px;
        margin-left: 24px;
      }
      
      span {
        color: gray;
        font-family: 'Montserrat', sans-serif;
        margin: 14px; 
      }
      #filters{
        font-family: 'Montserrat';
        color: white;
        border: none;
        margin-left: 24px;
        width: 60vw;
      }
      
      .filterOption{
        border-width: 1px;
        margin-right: 8px;
        margin-bottom: 8px;
        margin-top: 8px;
        height: 32px;
        background-color: #aeaeae;
        color: white;
        font-size: 14px;
        font-family: 'Montserrat'
      }

      #graphs {
        display: inline-block;
        width: 80%;
      }

      .graph {
        border-radius: 3px;
        padding: 4px;
        margin: 8;
        background-color: #ffffff;
        width: 20vw;
        height: 20vh;
      }

      #legend {
        display: inline-block; 
        position: relative; 
        width: 20%;
        top: 0px;
        background-color: #C4C4C4;
        margin: 24px;
      }

    </style>
  </head>

  <body>
    <div id="main-wrapper">
      <h2> Four days in the life</h1> <span><img src="a3-legend-03.png" alt="legend" style="float:right;width:326px;"></span>
      <h3>What is it like to struggle with depression?</h2>
      <p> Find individual stories for... <p/>
      
      <div id="filters" class="">
        <select id="Age" class="filterOption"></select>
        <span>year old</span>
        <select id="Gender" class="filterOption"></select>
        <span>people who identify as</span>
        <select id="Sexual_Identity" class="filterOption"></select>
        <span>with a total family income of</span>
        <select id="Total_Family_Income" class="filterOption"></select>
        </span>.</span>
      </div>

      <div id="graphsContainer">
        <table id="graphs">
          <tr> 
            <td id="graph1Container" class="graph"><div id="graph1"></div><div class="graphText">Placeholder Text</div></td>
            <td id="graph2Container" class="graph"><div id="graph2"></div><div class="graphText">Placeholder Text</div></td>
             <td id="graph3Container" class="graph"><div id="graph3"></div><div class="graphText">Placeholder Text</div></td>
            <td id="graph4Container" class="graph"><div id="graph4"></div><div class="graphText">Placeholder Text</div></td>
          </tr>
        </table>
        <div id="legend" class="graph"></div> <!-- should probably generalize the name of the graph class so that this makes sense, or use another class to style it -->
      </div>
    </div>
  </body>

  <script type="text/javascript">

    var chartMargin = "8px";
    var chartHeight = "20vh";
    var chartWidth = "20vw";

    var graphHeight = "350";
    var graphWidth = "350";

    var legendWidth = "20%";

    /* var fakeData = [
      {"age":"24-25", "sex": "Male", "orientation": "Gay or Lesbian", "income": "$50,000-$74,999", "marital_status": "Married"},
      {"age":"65+", "sex": "Female", "orientation": "Bi/Pansexual", "income": "$30,000- $39,999", "marital_status": "Widowed"},
      {"age":"18", "sex": "Female", "orientation": "Heterosexual", "income": "Less than $10,000 (Including Loss)", "marital_status": "Never Been Married"},
      {"age":"40-44", "sex": "Male", "orientation": "Heterosexual", "income": "$75,000 or more", "marital_status": "Never Been Married"},
      {"age":"50-64", "sex": "Female", "orientation": "Homosexual", "income": "$75,000 or more", "marital_status": "Divorced or Separated"},
    ]; */

    /* var randomData = randomEntries(fakeData); */

    // for headers & drop down values
    var key = {
      "Age": ["18", "19", "20", "21", "23-22", "24-25", "26-29", "30-34", "35-39", "40-44", "45-49", "50-64", "65+"],
      "Gender": ["Male", "Female"],
      "Sexual_Identity": ["Heterosexual", "Lesbian or Gay", "Bisexual"],
      "Total_Family_Income": ["Less than $10,000 (Including Loss)", "$10,000 - $19,999", "$20,000 - $29,999", "$30,000 - $39,999", "$40,000 - $49,999", "$50,000 - $74,999", "$75,000 or more"]
    };

    var plotLayout = {
        polar: {
          radialaxis: {
            visible: true,
            range: [0, 10]
          }
        },
        width: graphWidth,
        height: graphHeight,
        showlegend: false
      };

    var plotAddlParams = {
      showSendToCloud: false, 
      displayModeBar: false, 
      staticPlot: true
    };

    // for using csv
    d3.csv('data/a3_df_inverted.csv')
    .then(function(data) {
      var randomData = randomEntries(data);

      var selectRow = d3.select("#filters")
      .attr("style", "display: inline-block;");
    
      var selectAge = selectRow.select("#Age")
        .on("change", update);
      var selectGender = selectRow.select("#Gender")
        .on("change", update);
      var selectOrientation = selectRow.select("#Sexual_Identity")
        .on("change", update);
      var selectIncome = selectRow.select("#Total_Family_Income")
        .on("change", update);

      var valuesAge = ["Any Age"].concat(key.Age);
      var valuesGender = ["Any Gender"].concat(key.Gender);
      var valuesOrientation = ["Any Sexual Identity"].concat(key.Sexual_Identity);
      var valuesIncome = ["Any Income"].concat(key.Total_Family_Income);

      var optionsAge = selectAge.selectAll(null)
        .data(valuesAge)
        .enter()
        .append("option")
        .text(function(d) {return d;});
      var optionsGender = selectGender.selectAll(null)
        .data(valuesGender)
        .enter()
        .append("option")
        .text(function(d) {return d;});
      var optionsOrientation = selectOrientation.selectAll(null)
        .data(valuesOrientation)
        .enter()
        .append("option")
        .text(function(d) {return d;});
      var optionsIncome = selectIncome.selectAll(null)
        .data(valuesIncome)
        .enter()
        .append("option")
        .text(function(d) {return d;});

      var graphsContainer = d3.select("#graphsContainer")
        .attr("width", chartWidth + chartMargin)
        .attr("height", chartHeight + chartMargin)
        .attr("style", "display: inline-block;");

      var graphs = d3.select("#graphs")
        .attr("width", "80%")
        .attr("style", "display: inline-block; position: relative;");

      var legend = d3.select("#legend")
        .attr("width", legendWidth)
        .attr("height", chartHeight)
        .attr("style", "display: inline-block; position: relative; top: 0;");

      data1 = setupPlotData(randomData[0]);
      data2 = setupPlotData(randomData[1]);
      data3 = setupPlotData(randomData[2]);
      data4 = setupPlotData(randomData[3]);

      Plotly.plot("graph1", data1, plotLayout, plotAddlParams);
      Plotly.plot("graph2", data2, plotLayout, plotAddlParams);
      Plotly.plot("graph3", data3, plotLayout, plotAddlParams);
      Plotly.plot("graph4", data4, plotLayout, plotAddlParams);


      function update() {
        var choices = {};
        d3.selectAll(".filterOption")
          .each(function(d) {
            if (!this.value.startsWith("Any")) {
              choices[this.id] = this.value;
            }
          });

        var randomNewData;
        if (d3.keys(choices).length > 0) {
          var newData = data.filter(function(d,i) {
            var valid = true;
            for (var prop in choices) {
              if (d[prop] != choices[prop]) {
                valid = false;
                break;
              }
            }
            if (valid) {
              return d;
            }
          });
          randomNewData = randomEntries(newData);
          console.log(randomNewData, "subdata");
        } else {
          randomNewData = randomEntries(data);
          console.log(randomNewData, "general data");
        }

        var data1 = setupPlotData(randomNewData[0]);
        var data2 = setupPlotData(randomNewData[1]);
        var data3 = setupPlotData(randomNewData[2]);
        var data4 = setupPlotData(randomNewData[3]);

        var g1c = d3.select("#graph1Container");
        var g2c = d3.select("#graph2Container");
        var g3c = d3.select("#graph3Container");
        var g4c = d3.select("#graph4Container");

        if (data1.length > 0) {
          Plotly.react("graph1", data1, plotLayout, plotAddlParams);
        } else {
          console.log("data1 missing");
          g1c.attr("style", "display: none;");
        }
        if (data2.length > 0) {
          g2c.attr("style", "display: inline-block;");
          Plotly.react("graph2", data2, plotLayout, plotAddlParams);
        } else {
          console.log("data2 missing");
          g2c.attr("style", "display: none;");
        }
        if (data3.length > 0) {
          g3c.attr("style", "display:inline-block;");
          Plotly.react("graph3", data3, plotLayout, plotAddlParams);
        } else {
          console.log("data3 missing");
          g3c.attr("style", "display: none;");
        }
        if (data4.length > 0) {
          console.log(g4c.attr("style"), "-- style4");
          g4c.attr("style", "display: inline-block;");
          Plotly.react("graph4", data4, plotLayout, plotAddlParams);
        } else {
          console.log(data4, "data4 missing");
          g4c.attr("style", "display: none;");
        }

      }

    })
    .catch(function(error) {
      console.log(error, ": could not load csv");
    });


    function randomEntries(d) {
      var n = d.length;
      var dCopy = Object.assign([], d);

      values = [];
      for (i = 0; i < 4; i++) {
        idx = d3.randomUniform(n)();
        values = values.concat(dCopy.splice(idx, 1));
        n -= 1;
        if (n == 0) {
          break;
        }
      }

      return values;
    }


    function setupPlotData(d) {
      console.log(d, "-- dsetup");
      if (d != null) {
        radii = [d.ADPSWORK, d.ADPSRELS, d.ADPSSOC, d.ADPSHMGT, d.ADPSWORK];
        console.log(radii, "-- rsetup");
        return [{
        type: 'scatterpolar',
        r: radii,
        theta: ['Work', 'Relationships', 'Social', 'Home Management', 'Work'],
        fill: 'toself',
             fillcolor: 'rgba(124, 249, 249, .50)',
             line: {color: 'rgba(124, 249, 249, 1)', shape: "spline", smoothing: 1.3},
             marker: {color: 'rgba(177, 177, 180, 1)' }
        }]
      } else {
        return [];
      }
    }

    function updatePlotData(d) {
      // console.log(d, "-- d");
      if (d != null) {
        radii = [d.ADPSWORK, d.ADPSRELS, d.ADPSSOC, d.ADPSHMGT, d.ADPSWORK];
        return { r: radii };
      }
      return { r: [] };
      // console.log(radii, "-- r");
      
    }

  </script>
